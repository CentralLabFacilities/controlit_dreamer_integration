#!/usr/bin/env python

'''
This uses both posture and orientation control to make Dreamer shake hands.
'''

import sys, getopt     # for getting and parsing command line arguments
import time
import math
import threading
import rospy

from std_msgs.msg import Float64, Float64MultiArray, MultiArrayDimension, Bool, Int32

import numpy as np
from scipy.interpolate import interp1d
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D

import DreamerInterface
import Trajectory
import TrajectoryGeneratorCubicSpline

ENABLE_USER_PROMPTS = False

# Shoulder abductors about 10 degrees away from body and elbows bent 90 degrees
# DEFAULT_POSTURE = [0.0, 0.0,                                    # torso
#                    0.0, 0.174532925, 0.0, 1.57, 0.0, 0.0, 0.0,  # left arm
#                    0.0, 0.174532925, 0.0, 1.57, 0.0, 0.0, 0.0]  # right arm

# Shoulder abductors and elbows at about 10 degrees
DEFAULT_POSTURE = [0.0, 0.0,                                    # torso
                   0.0, 0.174532925, 0.0, 0.174532925, 0.0, 0.0, 0.0,  # left arm
                   0.0, 0.174532925, 0.0, 0.174532925, 0.0, 0.0, 0.0]  # right arm

class Demo5_HandShake:
    def __init__(self, dreamerInterface):
        self.dreamerInterface = dreamerInterface
        self.createTrajectories()

    def createTrajectories(self):

        # ==============================================================================================
        # Define the GoToReady trajectory
        self.trajGoToReady = Trajectory.Trajectory("GoToReady", 2.5)

        # These are the initial values as specified in the YAML ControlIt! configuration file
        self.trajGoToReady.setInitRHCartWP([0.033912978219317776, -0.29726881641499886, 0.82])
        self.trajGoToReady.setInitLHCartWP([0.033912978219317776, 0.29726881641499886, 0.82])
        self.trajGoToReady.setInitRHOrientWP([1.0, 0.0, 0.0])
        self.trajGoToReady.setInitLHOrientWP([1.0, 0.0, 0.0])
        self.trajGoToReady.setInitPostureWP(DEFAULT_POSTURE)
        
        self.trajGoToReady.addRHCartWP([0.17932609171050676, -0.1947116107098258, 0.8387314141057434])
        self.trajGoToReady.addRHCartWP([0.2761888140937166, -0.2014111570190916, 0.934860166427957])
        self.trajGoToReady.addRHCartWP([0.3568508489208336, -0.2522742841735632, 1.0477901706353308])

        self.trajGoToReady.addRHOrientWP([0.8389283544759069, -0.12533099736713216, 0.5296143475731253])
        self.trajGoToReady.addRHOrientWP([0.2235723628903799, -0.7215894666621694, 0.6552282351622359])
        self.trajGoToReady.addRHOrientWP([-0.030540625256204334, -0.9939692971780734, 0.1053200193519126])

        self.trajGoToReady.addLHCartWP([0.02965705887441486, 0.23088636680912317, 0.810922355509038])
        self.trajGoToReady.addLHCartWP([0.029689571433364353, 0.23083475171780563, 0.8109351922278043])
        self.trajGoToReady.addLHCartWP([0.02985679760506356, 0.23060205142957346, 0.8108808654985685])

        self.trajGoToReady.addLHOrientWP([0.9974231896120277, 0.03885099712962302, 0.06031236064193728])
        self.trajGoToReady.addLHOrientWP([0.9973855628117416, 0.039156806343972415, 0.06073535717887724])
        self.trajGoToReady.addLHOrientWP([0.9973534260815909, 0.03959962399135038, 0.06097551363503542])

        self.trajGoToReady.addPostureWP([0.022154761602009465, 0.022154761602009465, -0.24128221587505694, 0.03695440579936058, -0.025257242521253893, 0.6140504454635949, 0.0779998778955152, -0.2683878329384452, 0.0006097929281019635, 0.027855020993482953, -0.041381215034669044, -0.005952573692931204, 0.6552616241979254, 0.10812051456834937, -0.07093969869957849, -0.09962853201157851])
        self.trajGoToReady.addPostureWP([0.021791076348124116, 0.021791076348124116, -0.24126772903690724, 0.03678783103820191, -0.025068049370090353, 0.614121885152926, 0.07793206088242675, -0.2685578796206052, 0.0008613719366874122, 0.08441237407874143, -0.030654446867288323, -0.009171947872870517, 1.053685612334746, 0.7875534805163547, 0.11839301075003532, -0.32005664846914467])
        self.trajGoToReady.addPostureWP([0.02261344933362008, 0.02261344933362008, -0.24046242047415964, 0.03612594842600267, -0.024443836417768035, 0.6141064688418445, 0.07759789575168982, -0.26756988346271293, 0.0018279130452489236, 0.27597656277256155, 0.012763093450392634, 0.11650789924507622, 1.2552150356689133, 1.4437630086869198, -0.07478599278803119, -0.12877855214133435])

        # ==============================================================================================
        self.trajShake = Trajectory.Trajectory("Shake", 5.0)
        self.trajShake.setPrevTraj(self.trajGoToReady)

        self.trajShake.addRHCartWP([0.3557180774957711, -0.25310939617686734, 1.0483979760779218])
        self.trajShake.addRHCartWP([0.3761493884822581, -0.2481461952793942, 1.1132206313855328])
        self.trajShake.addRHCartWP([0.3648412333314974, -0.24579941328287044, 1.146518487910175])
        self.trajShake.addRHCartWP([0.3578116513927244, -0.23800263902719157, 1.0649127442304507])
        self.trajShake.addRHCartWP([0.3389102196570518, -0.23399734039978057, 1.0108847767607665])
        self.trajShake.addRHCartWP([0.31430074662547813, -0.22532843838634853, 0.9618879807239903])
        self.trajShake.addRHCartWP([0.35052009181683585, -0.22691944498062208, 1.005313077231368])
        self.trajShake.addRHCartWP([0.35387595026099766, -0.2286512604040531, 1.032278420403245])
        self.trajShake.addRHCartWP([0.35597832384006023, -0.2269100065110306, 1.048904361433809])

        self.trajShake.addRHOrientWP([-0.041833241693073245, -0.9934917283997733, 0.10594416213591153])
        self.trajShake.addRHOrientWP([-0.05282163349110273, -0.9948151860140378, 0.08690581517474481])
        self.trajShake.addRHOrientWP([-0.07039017161181636, -0.9945286986056281, 0.07718737843880126])
        self.trajShake.addRHOrientWP([-0.0305023102684167, -0.997964646396159, 0.05600155008281597])
        self.trajShake.addRHOrientWP([-0.010790390909406193, -0.9986002629585505, 0.051779168428393425])
        self.trajShake.addRHOrientWP([0.008059260852763183, -0.9995196345884035, 0.029925714473861834])
        self.trajShake.addRHOrientWP([-0.016547148449811443, -0.9995043934968159, 0.02677982932623204])
        self.trajShake.addRHOrientWP([-0.023019425006224743, -0.9992201285110044, 0.032081783785111485])
        self.trajShake.addRHOrientWP([-0.0258358344454711, -0.9992665034520196, 0.028265964290664924])

        self.trajShake.addLHCartWP([0.029756616688922446, 0.23054779462098512, 0.8108727961310923])
        self.trajShake.addLHCartWP([0.030006124178711138, 0.2305333166519316, 0.8108985969008216])
        self.trajShake.addLHCartWP([0.03016766842945406, 0.2306331032264583, 0.810883281536865])
        self.trajShake.addLHCartWP([0.029460428608280707, 0.23056598813368037, 0.8108359760649471])
        self.trajShake.addLHCartWP([0.029364638436939514, 0.23052081224213836, 0.8108089328438863])
        self.trajShake.addLHCartWP([0.029557408868478553, 0.23052641241735103, 0.81081024486407])
        self.trajShake.addLHCartWP([0.029467350906769173, 0.23053069467333287, 0.8108487910345771])
        self.trajShake.addLHCartWP([0.02976453458794904, 0.23046931111247873, 0.810838118230119])
        self.trajShake.addLHCartWP([0.02949062155520409, 0.23049314659691877, 0.8108285771888992])

        self.trajShake.addLHOrientWP([0.9973718730464771, 0.039706513811284545, 0.060603132070186444])
        self.trajShake.addLHOrientWP([0.9973120239071492, 0.03959348439003086, 0.061652923402564966])
        self.trajShake.addLHOrientWP([0.9973262688270156, 0.039837162936334714, 0.06126429593790958])
        self.trajShake.addLHOrientWP([0.9974559602705658, 0.039579038621214015, 0.05928833799782316])
        self.trajShake.addLHOrientWP([0.997478016113864, 0.03966246050363784, 0.05885997448476721])
        self.trajShake.addLHOrientWP([0.9974739912922751, 0.03972918339030584, 0.05888317826508758])
        self.trajShake.addLHOrientWP([0.9974171739409766, 0.039708643850482186, 0.05985152237956016])
        self.trajShake.addLHOrientWP([0.9973989313458699, 0.0397192093848442, 0.06014778596058045])
        self.trajShake.addLHOrientWP([0.9974421101569649, 0.03989121765526597, 0.0593121205117593])

        self.trajShake.addPostureWP([0.022765409132240337, 0.022765409132240337, -0.2404892614508488, 0.036021217559504035, -0.02445519063662262, 0.614165782896442, 0.07770859114925704, -0.2677449642498369, 0.001693459308099368, 0.27188300738368654, 0.01276584248311814, 0.11935786210488696, 1.2628717736539103, 1.4442236313403225, -0.06642787213957949, -0.11993872786897092])
        self.trajShake.addPostureWP([0.022235573980817002, 0.022235573980817002, -0.24051931354934794, 0.03597289740112775, -0.024399141397334664, 0.6141340692510722, 0.07752698585844321, -0.26765918682402723, 0.001891421438748879, 0.3530099503783779, -0.0007076664721352797, 0.1151897133639484, 1.3952038669932911, 1.4564185389886024, -0.07183237532336138, -0.12581404582846598])
        self.trajShake.addPostureWP([0.02275295016051939, 0.02275295016051939, -0.2399119415589129, 0.03611852835176923, -0.02426104799105879, 0.6140623728200241, 0.07768334314495029, -0.26774312465580613, 0.0019803676458763336, 0.3366100469988246, -0.012421715932130028, 0.11695478892588583, 1.5431868392145478, 1.4620481359724566, -0.06845858109373108, -0.11842822144168214])
        self.trajShake.addPostureWP([0.023506573249940682, 0.023506573249940682, -0.24060205279253155, 0.036153009703966225, -0.02446954209215202, 0.6141760609138072, 0.07756651598310922, -0.26755722468511856, 0.0020264219874164837, 0.2739405764447135, -0.03188615027853967, 0.11899388961077507, 1.3315773617919682, 1.455934331346002, -0.07651048108975356, -0.09483007494263743])
        self.trajShake.addPostureWP([0.02385140267872435, 0.02385140267872435, -0.2404689206256493, 0.035864987411943126, -0.02428673266653904, 0.6141003517820035, 0.07748866008130743, -0.2674625786369761, 0.0019702333738399443, 0.22406147465117704, -0.035572081971948534, 0.11857686359773885, 1.1971820764791314, 1.445385777225051, -0.07612506367250868, -0.09581313557333931])
        self.trajShake.addPostureWP([0.02374928718626608, 0.02374928718626608, -0.2401206127602841, 0.035971555553470654, -0.024454122244827778, 0.6140464770759824, 0.07765311038466621, -0.267690847235246, 0.0021097186362510037, 0.18385868678726716, -0.04973473469953155, 0.11986558683671111, 1.0620922805606778, 1.4377028581693003, -0.07708784852600158, -0.09311758973278456])
        self.trajShake.addPostureWP([0.02251652064558661, 0.02251652064558661, -0.24112698024512333, 0.0359364813169685, -0.024441315850789416, 0.6139840859468034, 0.07761419262389752, -0.2679744158830752, 0.001893192926399162, 0.27246464636920553, -0.04988543542257273, 0.12056542954733615, 1.1166328863150952, 1.4504742445624623, -0.06368883941980943, -0.11403579788236663])
        self.trajShake.addPostureWP([0.02296008702393193, 0.02296008702393193, -0.24028004455113536, 0.03586847546009893, -0.024471379816884076, 0.6139533656238672, 0.07764016210860777, -0.26771707570626113, 0.0018805986096601943, 0.2664919546435379, -0.05098024794765139, 0.11797961396070705, 1.2243203697047966, 1.4536327081833404, -0.06654379288833455, -0.11084572402975211])
        self.trajShake.addPostureWP([0.023260818508675944, 0.023260818508675944, -0.24046288350114936, 0.03589900072236511, -0.02425938299126323, 0.614092822713246, 0.07764263965283584, -0.2676172726351122, 0.002182773078153543, 0.26809913330028784, -0.058955748530055634, 0.11700005165938254, 1.2850068683831226, 1.454487874592255, -0.06740979496232208, -0.0976162808466806])

        # ==============================================================================================        
        self.trajGoToIdle = Trajectory.Trajectory("GoToIdle", 2.5)
        self.trajGoToIdle.setPrevTraj(self.trajShake)

        self.trajGoToIdle.addRHCartWP([0.3568508489208336, -0.2522742841735632, 1.0477901706353308])
        self.trajGoToIdle.addRHCartWP([0.2761888140937166, -0.2014111570190916, 0.934860166427957])
        self.trajGoToIdle.addRHCartWP([0.17932609171050676, -0.1947116107098258, 0.8387314141057434])
        # self.trajGoToIdle.addRHCartWP([0.25342182518741946, -0.23249440323488493, 0.8583425239604793])
        self.trajGoToIdle.addRHCartWP([0.033912978219317776, -0.29726881641499886, 0.82])

        self.trajGoToIdle.addRHOrientWP([-0.030540625256204334, -0.9939692971780734, 0.1053200193519126])
        self.trajGoToIdle.addRHOrientWP([0.2235723628903799, -0.7215894666621694, 0.6552282351622359])
        self.trajGoToIdle.addRHOrientWP([0.8389283544759069, -0.12533099736713216, 0.5296143475731253])
	# self.trajGoToIdle.addRHOrientWP([0.6730021599472973, 0.031757024689336236, 0.7389584454413883])
        self.trajGoToIdle.addRHOrientWP([1.0, 0.0, 0.0])


        self.trajGoToIdle.addLHCartWP([0.02985679760506356, 0.23060205142957346, 0.8108808654985685])
        self.trajGoToIdle.addLHCartWP([0.029689571433364353, 0.23083475171780563, 0.8109351922278043])
        self.trajGoToIdle.addLHCartWP([0.02965705887441486, 0.23088636680912317, 0.810922355509038])
        #self.trajGoToIdle.addLHCartWP([0.25342182518741946, 0.23249440323488493, 0.8583425239604793])
        self.trajGoToIdle.addLHCartWP([0.033912978219317776, 0.29726881641499886, 0.82])	

        self.trajGoToIdle.addLHOrientWP([0.9973534260815909, 0.03959962399135038, 0.06097551363503542])
        self.trajGoToIdle.addLHOrientWP([0.9973855628117416, 0.039156806343972415, 0.06073535717887724])
        self.trajGoToIdle.addLHOrientWP([0.9974231896120277, 0.03885099712962302, 0.06031236064193728])
        #self.trajGoToIdle.addLHOrientWP([0.6730021599472973, 0.031757024689336236, 0.7389584454413883])
        self.trajGoToIdle.addLHOrientWP([1.0, 0.0, 0.0])

        self.trajGoToIdle.addPostureWP([0.02261344933362008, 0.02261344933362008, -0.24046242047415964, 0.03612594842600267, -0.024443836417768035, 0.6141064688418445, 0.07759789575168982, -0.26756988346271293, 0.0018279130452489236, 0.27597656277256155, 0.012763093450392634, 0.11650789924507622, 1.2552150356689133, 1.4437630086869198, -0.07478599278803119, -0.12877855214133435])
        self.trajGoToIdle.addPostureWP([0.021791076348124116, 0.021791076348124116, -0.24126772903690724, 0.03678783103820191, -0.025068049370090353, 0.614121885152926, 0.07793206088242675, -0.2685578796206052, 0.0008613719366874122, 0.08441237407874143, -0.030654446867288323, -0.009171947872870517, 1.053685612334746, 0.7875534805163547, 0.11839301075003532, -0.32005664846914467])
        self.trajGoToIdle.addPostureWP([0.022154761602009465, 0.022154761602009465, -0.24128221587505694, 0.03695440579936058, -0.025257242521253893, 0.6140504454635949, 0.0779998778955152, -0.2683878329384452, 0.0006097929281019635, 0.027855020993482953, -0.041381215034669044, -0.005952573692931204, 0.6552616241979254, 0.10812051456834937, -0.07093969869957849, -0.09962853201157851])
        #self.trajGoToIdle.addPostureWP([0.09559710847417426, 0.09559710847417426,
            #0.18493035171345457, -0.018093572235340995, 0.12375741975377275, 0.7804877049806426, -0.12790804246025334, 0.06510619728499865, -0.04870942823921384,
            #0.18493035171345457, -0.018093572235340995, 0.12375741975377275, 0.7804877049806426, -0.12790804246025334, 0.06510619728499865, -0.04870942823921384])
        self.trajGoToIdle.addPostureWP(DEFAULT_POSTURE)


    def run(self, enablePrompts = True):
        """
        Runs the Cartesian and orientation demo 5 behavior.
        """

        if not self.dreamerInterface.connectToControlIt(DEFAULT_POSTURE):
            return

        # print "Trajectory Wave:\n {0}".format(self.trajShake)

        if enablePrompts:
            response = raw_input("Start demo? Y/n\n")
            if response == "N" or response == "n":
                return

        #=============================================================================
        if not self.dreamerInterface.followTrajectory(self.trajGoToReady):
            return

        #=============================================================================
        done = False
        while not done:
            if not self.dreamerInterface.followTrajectory(self.trajShake):
                return

            if enablePrompts:
                response = raw_input("Shake again? Y/n\n")
                if response == "N" or response == "n":
                    done = True
                else:
                    self.trajShake.setPrevTraj(self.trajShake)
            else:
                done = True   # Assume that if prompts are disabled we only want to shake hands once

        #=============================================================================
        if not self.dreamerInterface.followTrajectory(self.trajGoToIdle):
            return

# Main method
if __name__ == "__main__":

    rospy.init_node('Demo5_HandShake', anonymous=True)

    dreamerInterface = DreamerInterface.DreamerInterface(ENABLE_USER_PROMPTS)

    demo = Demo5_HandShake(dreamerInterface)

    demo.run()

    print "Demo 5 done, waiting until ctrl+c is hit..."
    rospy.spin()  # just to prevent this node from exiting
